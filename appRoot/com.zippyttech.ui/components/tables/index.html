<div class="table-responsive" *ngIf="model.dataList && model.dataList.list" >
    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <th data-type = "html" *ngFor="let key of keyVisible()" [class.check]="model.rules[key].check" (click)="changeOrder(key)" class="cursor-pointer" [attr.title]="'Ordenar por la columna '+model.rules[key].title">
                <i *ngIf="model.rest.sort==key && model.rest.order == 'asc' && !model.rest.findData" class="fa fa-caret-up text-blue"></i>
                <i *ngIf="model.rest.sort==key && model.rest.order == 'desc' && !model.rest.findData" class="fa fa-caret-down text-blue"></i>
                <i *ngIf="model.rest.sort==key && model.rest.findData" class="fa fa-spinner fa-spin" [attr.title]="db.msg.pleaseWait"></i>
                &nbsp;{{model.rules[key].title}}
            </th>
            <th data-type = "html" *ngIf="params && params.actions">&nbsp;
                <tooltip-view [code]="model.prefix+'_5'"></tooltip-view>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let data of model.dataList.list"  [class.deleted]="data.deleted">
            <td *ngFor="let key of keyVisible()" [class.check]="model.rules[key].check">

                <span *ngIf="!getDisabledField(key,data)">
                    <i *ngIf="model.rules[key].iconVisible" class="{{model.rules[key].iconVisible}}">&nbsp;</i>
                    <i *ngIf="model.rules[key].type == 'icon'" class="{{data[key]}}">&nbsp;</i>



                    <a *ngIf=" !model.rules[key].object &&
                                model.rules[key].type == 'text' ||
                                model.rules[key].type == 'textarea' ||
                                model.rules[key].type == 'number' ||
                                model.rules[key].type == 'select' ||
                                model.rules[key].type == 'password'"
                       x-editable [disabled]="!model.rules[key].update" [endpoint]="model.endpoint"
                       [function]="model.onEditable" [data]="data" [rules]="model.rules" [field]="key">
                    </a>
                    <button *ngIf="model.rules[key].type == 'select' && !model.rules[key].required && data[key]"
                            (click)="model.setNull(data,key)"
                            type="button" class="btn btn-box-tool"
                            title="Liberar"
                    >
                        <i class="fa fa-minus text-red"></i>
                    </button>

                    <div *ngIf="model.rules[key].type=='image'">
                        <img [attr.id]="'img'+data.id+'_'+key"
                             [attr.src]="data[key] || model.rules[key].default"
                             width="30" height="30"
                             data-toggle="modal" [attr.data-target]="'#'+data.id+'_'+key"
                             class="image-editor"
                             [attr.title]="model.rules[key].update?db.msg.imageEdit:''"
                        >

                        <div [attr.id]="data.id+'_'+key" class="modal fade" tabindex="-1" role="dialog"
                             aria-labelledby="myModalLabel">
                           <div class="modal-dialog" role="document">
                               <div class="modal-header bg-red text-center">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                            aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title">
                                        <i class="fa fa-image"></i>&nbsp;
                                        <strong>{{db.msg.imageEditor}}</strong>
                                    </h4>
                                </div>
                                <div class="modal-content">
                                    <image-edit-view
                                            [image]="data[key]"
                                            [default]="model.rules[key].default"
                                            (out)="model.onPatchValue(key,data, $event)"
                                    ></image-edit-view>
                                </div>
                           </div>
                        </div>
                    </div>


                    <input *ngIf="model.rules[key].type == 'color' && model.rules[key].update && !data.deleted" color-picker readonly
                           [style.background-color]="'#'+data[key]" [attr.value]="'#'+data[key]" [hexString]="data[key]"
                           (color)="model.onPatch(key,data,$event)">
                    <label *ngIf=" model.rules[key].type == 'color' && !model.rules[key].update " class="form-control">{{'#'+data[key]}}</label>


                    <button *ngIf="model.rules[key].type =='boolean'" class="{{getBooleandData(key,data).class}}"
                            (click)="model.onPatch(key,data)" [disabled]="getBooleandData(key,data).disabled || data.deleted" [attr.title]="getBooleandData(key,data).title">
                        {{getBooleandData(key,data).text}}
                    </button>

                    <a *ngIf="model.rules[key].object && key!='roles'">
                        <template [ngIf]="model.rules[key].eval">
                            {{evalExp(data,model.rules[key].eval)}}
                        </template>
                        <template [ngIf]="!model.rules[key].eval">
                            {{data[model.rules[key].keyDisplay]}}
                        </template>
                         <label *ngIf="model.permissions.update && (data.enabled==true || data.enabled==null) && !data.deleted">
                             <span *ngIf="!model.rules[key].reference">

                                 <button *ngIf="model.rules[key].multiple && data[key] && data[key].length > 0"
                                         (click)="setViewListData($event,data,key)"
                                         type="button" class="btn btn-box-tool"
                                         title="Listar" data-toggle="modal"
                                         data-target="#dataMultiple"
                                 >
                                     <i class="fa fa-list text-red"></i>
                                 </button>

                                 <button *ngIf="model.rules[key].paramsSave && model.rules[key].permissions.add"
                                         type="button" class="btn btn-box-tool"
                                         (click)="loadSaveModal($event,key,data)" title="Asignar nuevo"
                                         data-toggle="modal"
                                         [attr.data-target]="'#'+model.rules[key].paramsSave.idModal"
                                 >
                                     <i class="fa fa-plus text-green"></i>
                                 </button>

                                 <button *ngIf="model.rules[key].paramsSearch && model.rules[key].permissions.search"
                                         type="button" class="btn btn-box-tool"
                                         (click)="loadSearchTable($event,key,data)" title="Buscar"
                                         data-toggle="modal"
                                         [attr.data-target]="'#'+model.rules[key].paramsSearch.idModal">
                                     <i class="fa fa-search text-blue"></i>
                                 </button>

                                 <button *ngIf="data[model.rules[key].code] && !model.rules[key].required"
                                         (click)="model.setNull(data,key)"
                                         type="button" class="btn btn-box-tool"
                                         title="Liberar"
                                 >
                                     <i class="fa fa-minus text-red"></i>
                                 </button>
                             </span>
                             <span *ngIf="model.rules[key].reference">

                                 <button *ngIf="model.rules[key].multiple && data[key] && data[key].length > 0"
                                         (click)="setViewListData($event,data,key)"
                                         type="button" class="btn btn-box-tool"
                                         title="Listar" data-toggle="modal"
                                         data-target="#dataMultiple"
                                 >
                                     <i class="fa fa-list text-red"></i>
                                 </button>

                                 <button (click)="loadDataFieldReference(data,key)"
                                         *ngIf="model.permissions.update && model.rules[key].permissions.add"
                                         data-toggle="modal"
                                         [attr.data-target]="'#'+model.rules[key].paramsSave.idModal"
                                         type="button" class="btn btn-box-tool"
                                         title="Asignar nuevo"
                                 >
                                     <i class="fa fa-plus text-green"></i>
                                 </button>

                                  <button (click)="loadDataFieldReference(data,key)"
                                          *ngIf="model.permissions.update && model.rules[key].permissions.search && !model.rules[key].pathLocal"
                                          data-toggle="modal"
                                          [attr.data-target]="'#'+model.rules[key].paramsSearch.idModal"
                                          type="button" class="btn btn-box-tool"
                                          title="Asignar"
                                  >
                                      <i class="fa fa-search text-blue"></i>
                                  </button>


                                 <button *ngIf="model.rules[key].paramsSearch && model.rules[key].permissions.search && model.rules[key].pathLocal"
                                         type="button" class="btn btn-box-tool"
                                         (click)="loadSearchTable($event,key,data)" title="Buscar"
                                         data-toggle="modal"
                                         [attr.data-target]="'#'+model.rules[key].paramsSearch.idModal">
                                     <i class="fa fa-search text-blue"></i>
                                 </button>

                                 <button *ngIf="model.permissions.update && !model.rules[key].required && data[model.rules[key].code]"
                                         (click)="loadDataFieldReference(data,key,true)"
                                         type="button" class="btn btn-box-tool"
                                         title="Liberar">
                                     <i class="fa fa-minus text-red"></i>
                                 </button>
                             </span>
                         </label>
                        <label *ngIf="!(model.permissions.update && (data.enabled==true || data.enabled==null))">
                            <button *ngIf="model.rules[key].multiple && data[key] && data[key].length > 0"
                                    (click)="setViewListData($event,data,key)"
                                    type="button" class="btn btn-box-tool"
                                    title="Listar" data-toggle="modal"
                                    data-target="#dataMultiple"
                            >
                                     <i class="fa fa-list text-red"></i>
                                 </button>
                        </label>


                     </a>

                    <a x-editable *ngIf="key=='roles'"
                       [disabled]="!model.permissions.update || !model.rules[key].permissions.list || !model.permissions.roleSave || data.deleted"
                       [endpoint]="'/users/'+data.id+'/roles'"
                       [function]="model.onEditableRole" [data]="data" [rules]="model.rules"
                       field="roles">

                    </a>

                    <span *ngIf="model.rules[key].type =='date'">
                        {{formatDate(data[key],model.rules[key].format?model.rules[key].format.formatView:'DD/MM/YYYY',false,data.id)}}
                        <i *ngIf="viewChangeDate(data[key])" class="fa fa-exchange btn"
                           (click)="changeFormatDate(data.id)"></i>
                    </span>

                     <span *ngIf="model.rules[key].type =='time'">
                        {{formatTimeView(data[key])}}
                    </span>

                    <span *ngIf="model.rules[key].type =='eval'">
                        {{getTypeEval(key,data)}}
                    </span>

                </span>
                <span *ngIf="getDisabledField(key,data)">
                    <label class="label label-orange">N/A</label>
                </span>

            </td>
            <td *ngIf="params && params.actions">

                <div class="btn-group dropdown pull-right" *ngIf="keyActions.length > 1 && !data.deleted">
                    <button type="button" data-toggle="dropdown"
                            class="btn btn-box-tool dropdown-toggle"
                            aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-gears fa-lg"></i>
                    </button>
                    <ul role="menu" class="dropdown-menu text-left submenu-config">
                        <li *ngFor="let key of actionPermissionKey()">
                            <a *ngIf="key == 'delete' && data.enabled"
                               data-toggle="modal" [attr.data-target]="'#'+params.actions[key].idModal"
                               (click)="dataSelect = data" href="#">
                                <i class="{{params.actions[key].icon}}"></i>
                                &nbsp;{{params.actions[key].title}}
                            </a>
                            <a *ngIf="key == 'onPatch' && params.actions[key].type=='boolean'"
                               (click)="model.onPatch(params.actions[key].field,data)">
                                <span class="{{params.actions[key].icon}}"></span>
                                {{data[key]?params.actions[key].titleTrue:params.actions[key].titleFalse}}
                            </a>
                            <a *ngIf="key == 'onLock'"
                               (click)="model.onLock('enabled',data)">
                                <span class="{{params.actions[key].icon}}"></span>
                                {{data.enabled?params.actions[key].titleTrue:params.actions[key].titleFalse}}
                            </a>
                            <a *ngIf="key == 'viewHistory'" [attr.href]="params.actions[key].path+data.id">
                                <span class="{{params.actions[key].icon}}"></span>
                                &nbsp;{{params.actions[key].title}}
                            </a>
                        </li>
                    </ul>
                </div>
                <div *ngIf="keyActions.length == 1 && !data.deleted">

                    <div *ngFor="let key of actionPermissionKey()">
                        <a *ngIf="key == 'delete'  && data.enabled"
                           data-toggle="modal" [attr.data-target]="'#'+params.actions[key].idModal"
                           (click)="dataSelect = data" href="#">
                            <i class="{{params.actions[key].icon}}"></i>
                            &nbsp;{{params.actions[key].title}}
                        </a>
                        <a *ngIf="key == 'onPatch' && params.actions[key].type=='boolean'"
                           (click)="model.onPatch(params.actions[key].field,data)">
                            <span class="{{params.actions[key].icon}}"></span>
                            {{data[key]?params.actions[key].titleTrue:params.actions[key].titleFalse}}
                        </a>
                        <a *ngIf="key == 'onLock'"
                           (click)="model.onLock('enabled',data)">
                            <span class="{{params.actions[key].icon}}"></span>
                            {{data.enabled?params.actions[key].titleTrue:params.actions[key].titleFalse}}
                        </a>
                        <a *ngIf="key == 'viewHistory'" [attr.href]="params.actions[key].path+data.id">
                            <span class="{{params.actions[key].icon}}"></span>
                            &nbsp;{{params.actions[key].title}}
                        </a>
                    </div>
                </div>

            </td>
        </tr>
        </tbody>
        <tfoot *ngIf="model.dataList && model.dataList.page && model.dataList.page.length > 1">
        <tr>
            <td [attr.colspan]="keyVisible().length + 1">
                <div class="btn-group pull-right">
                    <button (click)="model.loadData(val)" [class.btn-green]="val==((model.rest.offset/model.rest.max)+1)"
                            *ngFor="let val of model.dataList.page" type="button" class="btn btn-default">
                        {{val}}
                    </button>
                    <tooltip-view [code]="model.prefix+'_9'"></tooltip-view>
                </div>
            </td>
        </tr>
        </tfoot>
    </table>
</div>

<div *ngIf="model.permissions.delete && params && params.actions && params.actions.delete">
    <div class="modal fade" [attr.id]="params.actions.delete.idModal" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header btn-red text-center">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title" id="myModalLabel"><i
                            class="fa fa-warning"></i>&nbsp;<strong>{{db.msg.warningTitle}}&nbsp;
                        <tooltip-view [code]="model.prefix+'_10'"></tooltip-view>
                    </strong></h3>
                </div>
                <div class="modal-body">
                    {{params.actions.delete.message}} <strong>'{{dataSelect[params.actions.delete.keyAction]}}'</strong>
                    ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outlined btn-red fa fa-close" data-dismiss="modal">&nbsp;{{db.msg.warningButtonExit}}</button>
                    <button (click)="model.onDelete($event,dataSelect.id)" data-dismiss="modal" type="button"
                            class="btn btn-red fa fa-trash">&nbsp;{{db.msg.delete}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div *ngFor="let key of getObjectKeys(modelSave)">
    <save-view [rules]="modelSave[key].rulesSave" [params]="modelSave[key].paramsSave"
               (save)="getDataSave($event,key)"></save-view>
</div>

<div *ngIf="searchTable && !searchTable.multiple && searchTable.idModal">
    <search-view [params]="searchTable" (result)="getDataSearch($event)" (getInstance)="setInstanceSearch('unique',$event)"></search-view>
</div>

<div *ngIf="searchTable && searchTable.multiple && searchTable.idModal">
    <search-multiple-view [params]="searchTable" (result)="getDataSearchMultiple($event)" (getInstance)="setInstanceSearch('multiple',$event)"></search-multiple-view>
</div>


<div *ngIf="modelReference && modelReference.paramsSave">
    <save-view [rules]="modelReference.rulesSave" [params]="modelReference.paramsSave"
               (save)="setDataFieldReference($event)"></save-view>
</div>
<div *ngIf="modelReference && modelReference.paramsSearch">
    <search-view [params]="modelReference.paramsSearch" (result)="setDataFieldReference($event)" (getInstance)="setInstanceSearch('reference',$event)"></search-view>
</div>

<div *ngIf="viewListData && viewListData.data">
    <div class="modal fade" id="dataMultiple" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">
                        <strong>{{viewListData.title}}</strong>
                    </h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-hover" *ngIf="getObjectKeys(viewListData.label).length">
                        <thead>
                        <tr>
                            <th *ngFor="let key of getObjectKeys(viewListData.label)">
                                {{viewListData.label[key]}}
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let data of viewListData.data">
                            <td *ngFor="let key of getObjectKeys(viewListData.label)">
                                {{data[key]}}
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <table class="table table-striped table-hover" *ngIf="!getObjectKeys(viewListData.label).length">
                        <tbody>
                        <tr *ngFor="let data of viewListData.data">
                            <td>{{data}}</td>
                        </tr>
                        </tbody>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outlined btn-red fa fa-close" data-dismiss="modal">&nbsp;{{db.msg.warningButtonExit}}</button>
                </div>
            </div>
        </div>
    </div>
</div>